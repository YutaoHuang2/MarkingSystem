<!DOCTYPE html>
<html>
<head>
  <title>在线阅卷系统</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css"> 
  <link rel="stylesheet" href="../style/frame.css"> 
  <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="http://cdn.bootcss.com/fabric.js/1.7.3/fabric.min.js" ></script>
</head>
<body>
  <div class="container-fluid">
		<div class="row top_bar">
			<div class="col-md-1"></div>
			<div class="col-md-9"></div>
			<div class="col-lg-2">
				<div class="dropdown">
					<button type="button" class="btn dropdown-toggle btn-lg"
						id="dropdownMenu1" data-toggle="dropdown">
						用户:1234
						<span class="caret"></span>
					</button>
					<ul class="dropdown-menu" role="menu"
						aria-labelledby="dropdownMenu1">
						<li role="presentation"><a role="menuitem" tabindex="-1"
							href="../index.html">退出登录</a></li>
						<li role="presentation"><a role="menuitem" tabindex="-1"
							href="#">修改信息</a></li>
					</ul>
				</div>
			</div>
		</div>
  </div>

  <div class="container-fluid">
    <div class="row-fluid">
      <div class="col-lg-1 right-side"></div>
      <div class="col-lg-7 right-side">    
        <div style=" float: left; width: 100%; height: 550px; overflow:scroll; ">
          <canvas id="canvas" width="1" height="1"></canvas>
        </div>
        <div style="width: 100%;">
          <button class="btn btn-info" id="zoomin">放大</button>
          <button class="btn btn-info" id="zoomout">缩小</button>
          <input id="checkbox" type="image" src="../image/checkbox.png" style="width:30px;height:30px"/>
          <input id="cross" type="image" src="../image/cross.png" style="width:30px;height:30px"/>
          <input id="blackline" type="image" src="../image/blackline.png" style="width:30px;height:30px"/>
        </div>
      </div>
      <div class="col-lg-4 right-side" ></br>
        <div>
          第一题<input type="number" step="any" class="q1" style="width: 100px;" value="0"></input>
          <div id="q1" class="btn-group btn-group-sm">
      		  <button type="button" class="btn btn-default">0</button>
      		  <button type="button" class="btn btn-default">1</button>
      		  <button type="button" class="btn btn-default">2</button>
      		  <button type="button" class="btn btn-default">3</button>
  		    </div></br>
          第二题<input type="number" step="any" class="q2" style="width: 100px;" value="0"></input>
          <div id="q2" class="btn-group btn-group-sm">
      		  <button type="button" class="btn btn-default">0</button>
      		  <button type="button" class="btn btn-default">1</button>
      		  <button type="button" class="btn btn-default">2</button>
  		    </div></br>
  		    第三题<input type="number" step="any" class="q3" style="width: 100px;" value="0"></input>
          <div id="q3" class="btn-group btn-group-sm">
      		  <button type="button" class="btn btn-default">0</button>
      		  <button type="button" class="btn btn-default">1</button>
      		  <button type="button" class="btn btn-default">2</button>
      		  <button type="button" class="btn btn-default">3</button>
      		  <button type="button" class="btn btn-default">4</button>
  		    </div></br>
  	     </div>
      <h3 id="score">总分:0</h3> 
  	  <button class="btn btn-info" id="submit">提交</button>
        <button class="btn btn-info">有问题</button></br></br>
        <textarea id="detail" cols="22" rows="20" disabled="true">评分细则</textarea>
      </div>
    </div>
  </div>


<script>

  var isDrawingLine = false;
  var zoomInFactor = 1.1;
  var zoomOutFactor = 1/zoomInFactor;
  var zoomTime = 0;
  var maxTimes = 3;
  var defaultScore = 0.0;
  var fullScore;
  var paperId;
  var topicId;
  var detail;
  var simage = 'data:image/png;base64,';
  var canvas = new fabric.Canvas('canvas');

  //加载图片
  $.ajax({
    method:'get',
    url:"../mark/getTopic",
    data: "topicNum=2&userId=1234",
    success:function(data){
      simage += data.dir;
      fullScore = data.fullMark;
      paperId = data.paperId;
      topicId = data.topicNum;
      $("#detail").val(data.detail);
      //在canvas中添加图片
      fabric.Image.fromURL(simage, function(oImg) {
        canvas.setWidth(oImg.width);
        canvas.setHeight(oImg.height);    
        oImg.crossOrigin = "anonymous";
        oImg.selectable = false;
        oImg.hoverCursor = '11';
        canvas.add(oImg);
      });
    },
  });
  
  //勾叉
  $('#checkbox').click(function (){
    isDrawingLine = false;
    fabric.Image.fromURL('../image/checkbox.png', function(oImg) {
      oImg.width = 60;
      oImg.height = 60;
      oImg.hoverCursor = '11';
      canvas.add(oImg);
    });
  })

  $('#cross').click(function (){
    isDrawingLine = false;
    fabric.Image.fromURL('../image/cross.png', function(oImg) {
      oImg.width = 60;
      oImg.height = 60;
      oImg.hoverCursor = '11';
      canvas.add(oImg);
    });
  })

  //分数按钮
  $('#zeropoints').click(function (){
    $('#score').val("0");
  })

  $('#fullpoints').click(function (){
    $('#score').val(fullScore);
  })

  //提交
  $('#submit').click(function () {
    var dataURL = canvas.toDataURL({
      format: 'png',
      multiplier: 1/1.25
    });
    var dataU = dataURL.substring(22);
    var param = "userId=1234&time=0&paperId=" + paperId + "&topicId=" + topicId + "&point=3" +  + "&image=" + dataU;
    console.log(dataU);
    $.ajax({
      method:'post',
      url:"../mark/store",
      data: param,
      success:function(data){
      },
    });
    defaultScore = 0.0;    
  })

  //缩放
  $('#zoomout').click(function (){
    if (zoomTime > -maxTimes) {
      zoomTime -= 1;
      zoomIt(zoomOutFactor);
    }
  })

  $('#zoomin').click(function (){
    if (zoomTime < maxTimes) {
      zoomTime += 1;
      zoomIt(zoomInFactor);
    }
  })
  
  function zoomIt(factor) {
    canvas.setHeight(canvas.getHeight() * factor);
    canvas.setWidth(canvas.getWidth() * factor);
    if (canvas.backgroundImage) {
        var bi = canvas.backgroundImage;
        bi.width = bi.width * factor; bi.height = bi.height * factor;
    }
    var objects = canvas.getObjects();
    for (var i in objects) {
      var scaleX = objects[i].scaleX;
      var scaleY = objects[i].scaleY;
      var left = objects[i].left;
      var top = objects[i].top;

      var tempScaleX = scaleX * factor;
      var tempScaleY = scaleY * factor;
      var tempLeft = left * factor;
      var tempTop = top * factor;

      objects[i].scaleX = tempScaleX;
      objects[i].scaleY = tempScaleY;
      objects[i].left = tempLeft;
      objects[i].top = tempTop;

      objects[i].setCoords();
    }
    canvas.renderAll();
    canvas.calcOffset();
  }

  //划线部分
  $('#blackline').click(function (){
    isDrawingLine = true;
  })

  var line, isDown;
  canvas.on('mouse:down', function(o){
    if (!isDrawingLine)
      return;
    isDown = true;
    var pointer = canvas.getPointer(o.e);
    var points = [ pointer.x, pointer.y, pointer.x, pointer.y ];
    line = new fabric.Line(points, {
      strokeWidth: 1,
      fill: 'black',
      stroke: 'black',
      originX: 'center',
      originY: 'center'
    });
    canvas.add(line);
  });

  canvas.on('mouse:move', function(o){
    if (!isDown || !isDrawingLine) 
      return;
    var pointer = canvas.getPointer(o.e);
    line.set({ x2: pointer.x, y2: pointer.y });
    canvas.renderAll();
  });

  canvas.on('mouse:up', function(o){
    isDown = false;
    isDrawingLine = false;
  });
  
  //小题分数
  $(".btn").click(function(){
    var value = $(this).html();
    var id = $(this).parent().attr("id");
    $("input."+id).val(value);
    setScores();
  });
  $("input").blur(function(){
	setScores()
  })
  
  $("input.q1").blur(function(){
	if (parseFloat($("input.q1").val())> 3)
		$("input.q1").val(3);
	setScores();
  })
  
  $("input.q2").blur(function(){
	if (parseFloat($("input.q2").val())> 2)
		$("input.q2").val(2);
	setScores();
  })
  
  $("input.q3").blur(function(){
	if (parseFloat($("input.q3").val())> 4)
		$("input.q3").val(4);
	setScores();
  })
  function setScores() {
	var scores = parseFloat($("input.q1").val()) + parseFloat($("input.q2").val()) + parseFloat($("input.q3").val());
	$("#score").html("总分: " + scores); 
  }
  function timedMsg() {
	var t=setTimeout("alert('5 秒！')",5000)
  }
  </script>
  /*var crossOriginImageObj = new Image();
  crossOriginImageObj.crossOrigin = "Anonymous";
  crossOriginImageObj.src = "test.png";

  fabric.Image.fromObject(crossOriginImageObj, function(oImg) {
    canvas.setWidth(oImg.width);
    canvas.setHeight(oImg.height);
    //oImg.setCrossOrigin('anonymous');
    oImg.setAttribute("corssOrigin","anonymous")
    oImg.crossOrigin = "anonymous";
    oImg.selectable = false;
    oImg.hoverCursor = '11';
    canvas.add(oImg);
  });*/
</script>

<style type="text/css">
  canvas{
    border: 1px solid black;
  }
  .right-side {
    padding-top: 50px;
  }
</style>
</body>
</html>