<!DOCTYPE html>
<html>
<head>
  <title>Demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css"> 
  <link rel="stylesheet" href="frame.css">

  <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="http://cdn.bootcss.com/fabric.js/1.7.3/fabric.min.js" ></script>
</head>
<body>
<div class="container-fluid">
  <div class="row-fluid">
    <div class="col-lg-9 right-side">
      <div style=" float: left; width: 100%; height: 550px; overflow:scroll; ">
        <canvas id="canvas" width="1" height="1"></canvas>
      </div>
      <div style="width: 100%;">

        <button id="zoomin">放大</button>
        <button id="zoomout">缩小</button>
        <input id="checkbox" type="image" src="../image/checkbox.png" style="width:30px;height:30px"/>
        <input id="cross" type="image" src="../image/cross.png" style="width:30px;height:30px"/>
        <input id="blackline" type="image" src="../image/blackline.png" style="width:30px;height:30px"/>
      </div>
    </div>
    <div class="col-lg-1 right-side" >
    </div>

    <div class="col-lg-2 right-side" >
      <button>零分</button>
      <button>满分</button>
      </br>

      <button id="submit">提交</button>
      <button>有问题</button>
      分数<input></input>

      <textarea cols="22" rows="30">评分细则</textarea>
    </div>
  </div>
</div>


<script>
  var simage = 'data:image/png;base64,';
  $.ajax({
    method:'get',
    url:"../mark/getTopic",
    data: "topicNum=2&userId=1234",
    async: false,
    success:function(data){
      simage += data.dir;
    },
  });
  var isDrawingLine = false;
  var zoomInFactor = 1.1;
  var zoomOutFactor = 1/zoomInFactor;
  var zoomTime = 0;
  var maxTimes = 3;
  var canvas = new fabric.Canvas('canvas');
  var defaultScore = 0.0;
  /*var crossOriginImageObj = new Image();
  crossOriginImageObj.crossOrigin = "Anonymous";
  crossOriginImageObj.src = "test.png";

  fabric.Image.fromObject(crossOriginImageObj, function(oImg) {
    canvas.setWidth(oImg.width);
    canvas.setHeight(oImg.height);
    //oImg.setCrossOrigin('anonymous');
    oImg.setAttribute("corssOrigin","anonymous")
    oImg.crossOrigin = "anonymous";
    oImg.selectable = false;
    oImg.hoverCursor = '11';
    canvas.add(oImg);
  });*/
	console.log(simage);
  fabric.Image.fromURL(simage, function(oImg) {
    canvas.setWidth(oImg.width);
    canvas.setHeight(oImg.height);    
    oImg.crossOrigin = "anonymous";
    oImg.selectable = false;
    oImg.hoverCursor = '11';
    canvas.add(oImg);
  });
  
  $('#checkbox').click(function (){
    isDrawingLine = false;

    fabric.Image.fromURL('../image/checkbox.png', function(oImg) {
      oImg.width = 60;
      oImg.height = 60;
      oImg.hoverCursor = '11';
      canvas.add(oImg);
    });
  })

  $('#cross').click(function (){
    isDrawingLine = false;
    fabric.Image.fromURL('../image/cross.png', function(oImg) {
      oImg.width = 60;
      oImg.height = 60;
      oImg.hoverCursor = '11';
      canvas.add(oImg);
    });
  })

  $('#zoomout').click(function (){
    if (zoomTime > -maxTimes) {
      zoomTime -= 1;
      zoomIt(zoomOutFactor);
    }
  })

  $('#zoomin').click(function (){
    if (zoomTime < maxTimes) {
      zoomTime += 1;
      zoomIt(zoomInFactor);
    }
  })

  $('#blackline').click(function (){
    isDrawingLine = true;
  })

  $('#submit').click(function () {
    var dataURL = canvas.toDataURL({
      format: 'png',
      multiplier: 1/1.25
    });

    fabric.Image.fromURL(dataURL, function(oImg) {
      $.ajax({
        method:'get',
        url:"../mark/getTopic",
        data: "topicNum=2&userId=1234",
        async: false,
        success:function(data){
        console.log(data);
        console.log(data.id);
            simage += data.dir;
          
        },
      });
      defaultScore = 0.0;
    });
    
  })

  //缩放函数
  function zoomIt(factor) {
    canvas.setHeight(canvas.getHeight() * factor);
    canvas.setWidth(canvas.getWidth() * factor);
    if (canvas.backgroundImage) {
        // Need to scale background images as well
        var bi = canvas.backgroundImage;
        bi.width = bi.width * factor; bi.height = bi.height * factor;
    }
    var objects = canvas.getObjects();
    for (var i in objects) {
      var scaleX = objects[i].scaleX;
      var scaleY = objects[i].scaleY;
      var left = objects[i].left;
      var top = objects[i].top;

      var tempScaleX = scaleX * factor;
      var tempScaleY = scaleY * factor;
      var tempLeft = left * factor;
      var tempTop = top * factor;

      objects[i].scaleX = tempScaleX;
      objects[i].scaleY = tempScaleY;
      objects[i].left = tempLeft;
      objects[i].top = tempTop;

      objects[i].setCoords();
    }
    canvas.renderAll();
    canvas.calcOffset();
  }

  //划线部分
  var canvas = new fabric.Canvas('canvas', { selection: false });
  var line, isDown;

  canvas.on('mouse:down', function(o){
    if (!isDrawingLine)
      return;
    isDown = true;
    var pointer = canvas.getPointer(o.e);
    var points = [ pointer.x, pointer.y, pointer.x, pointer.y ];
    line = new fabric.Line(points, {
      strokeWidth: 1,
      fill: 'black',
      stroke: 'black',
      originX: 'center',
      originY: 'center'
    });
    canvas.add(line);
  });

  canvas.on('mouse:move', function(o){
    if (!isDown || !isDrawingLine) 
      return;
    var pointer = canvas.getPointer(o.e);
    line.set({ x2: pointer.x, y2: pointer.y });
    canvas.renderAll();
  });

  canvas.on('mouse:up', function(o){
    isDown = false;
    isDrawingLine = false;
  });
</script>
<style type="text/css">
  canvas{
    border: 1px solid black;
  }
  .right-side {
    padding-top: 90px;
  }
</style>
</body>
</html>